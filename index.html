<!DOCTYPE html>
<html>
  <head>
    <script
      src="https://global.oktacdn.com/okta-auth-js/7.2.0/okta-auth-js.min.js"
      type="text/javascript"
    ></script>
  </head>

  <body>
    <div id="groups"></div>
    <script type="module">
      import * as jose from 'https://cdnjs.cloudflare.com/ajax/libs/jose/4.14.4/index.bundle.min.js';

      const authClient = new OktaAuth({
        clientId: "0oa8ax6dbllrDchri1d7",
        redirectUri: "https://multi.phi1ipp.com",
        issuer: "https://okta.phi1ipp.com",
        responseType: "code",
      });
      
      if (authClient.isLoginRedirect()) {
        try {
          await authClient.handleLoginRedirect();
        } catch (e) {
          console.error(e);
        }
      } else if (!(await authClient.isAuthenticated())) {
        console.log('original URL', window.location.href);
        authClient.signInWithRedirect();
      } else {
        // User is authenticated
        console.log("user authenticated");
        
        fetch('https://okta.phi1ipp.com/api/v1/users/me/groups', {credentials: "include"})
          .then(rsp => rsp.json())
          .then(data => {
            const filteredGrps = data
                .filter(grp => grp.profile.name.startsWith('ORG - '))
                .map(grp => grp.profile.name)

            console.log('groups', filteredGrps)

            document.getElementById('groups').innerHTML = 
                '<select>'
                + filteredGrps.map(grpName => `<option>${grpName}</option>`).join()
                + '</select>'

            const secret = new TextEncoder().encode(
                'cc7e0d44fd473002f1c42167459001140ec6389b7353f8088f4d9a95f2f596f2',
            )
            const alg = 'HS256'

            new jose.SignJWT({ 'urn:example:claim': true })
                .setProtectedHeader({ alg })
                .setIssuedAt()
                .setIssuer('urn:example:issuer')
                .setAudience('urn:example:audience')
                .setExpirationTime('2h')
                .sign(secret)
                .then(jwt => {
                    console.log(jwt)
                })
          })
          .catch(err => {
            console.err(err)
          })
      }
    </script>
  </body>
</html>
